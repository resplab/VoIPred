<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Development EVPI tutorial • voipred</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Development EVPI tutorial">
<meta property="og:description" content="voipred">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">voipred</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/devEVPI_methods.html">Different methods for EVPI calculations</a>
    </li>
    <li>
      <a href="../articles/devEVPI_tutorial.html">Development EVPI tutorial</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Development EVPI tutorial</h1>
                        <h4 data-toc-skip class="author">Mohsen Sadatsafavi</h4>
            
            <h4 data-toc-skip class="date">February 06, 2022</h4>
      
      
      <div class="hidden name"><code>devEVPI_tutorial.Rmd</code></div>

    </div>

    
    
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>This tutorial is a step-by-step calculation of the Expected Value of Perfect Information (EVPI) for risk prediction models.</p>
<p>The EVPI developed in this document is the development EVPI: it estimates the distance,</p>
<ul>
<li><p>We have data of n individuals with a binary outcome (Y) and a set of predictors.</p></li>
<li><p>We have developed a risk prediction model for Y using these data</p></li>
<li><p>We know that because of the finite sample size, the regression coefficients of our model are uncertain</p></li>
<li><p>We are making our decision to use this model or not based on net benefit (NB) calculations, as defined in the classic paper by <a href="https://journals.sagepub.com/doi/10.1177/0272989X06295361?url_ver=Z39.88-2003&amp;rfr_id=ori:rid:crossref.org&amp;rfr_dat=cr_pub%20%200pubmed" class="external-link">Vickers and Elkin (Med Decis Making. 2006;26(6):565-574. doi:10.1177/0272989X06295361)</a>.</p></li>
<li><p>As a result of above, we know that the NB we estimate for our model, as well as for the ‘default’ decisions of treating no one and treating all, can e incorrect, and as such we might make incorrect conclusions about if our proposed model is better than the default decisions at threshold of interest.</p></li>
<li>
<p>We calculate EVPI as the expected distance in net benefit (NB) between a proposed model (that we just developed using some development data). We can then judge the value of EVPI todecide</p>
<ul>
<li>Whether a model is goof enough and should proceed to next stage</li>
<li>Whether it is not good and should be abandoned</li>
<li>Whether we cannoe arrive at a conclusion and need more development sample</li>
</ul>
</li>
</ul>
<p>We progress through a simple case study</p>
</div>
<div class="section level3">
<h3 id="the-development-data">The development data<a class="anchor" aria-label="anchor" href="#the-development-data"></a>
</h3>
<p>To keep things simple, we use the small and simple data set birthwt from the MASS package. These data are for the new born and were collected at Baystate Medical Center, Springfield, Mass during 1986.</p>
<p>Our outcome of interest is the binary variable ‘low’, taking a value of 1 if the baby’s weight is too low (&lt;2.5Kg).</p>
<p>We use the following 3 predictors:</p>
<p style="color:blue">
</p>
<p>age: mother’s age in years.</p>
<p>lwt: mother’s weight in pounds at last menstrual period.</p>
<p>smoke: smoking status during pregnancy.</p>

<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'birthwt'</span>, package<span class="op">=</span><span class="st">"MASS"</span><span class="op">)</span></code></pre></div>
<p>The data has rows. The outcome was observed in 59 births.</p>
<p>Because we are working with a subset of data, we keep a clean, targetted dataset that we call dev_data (development data).</p>
<p>Also, the risk threshold of interest is 0.2.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dev_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">birthwt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'age'</span>,<span class="st">'lwt'</span>,<span class="st">'smoke'</span><span class="op">)</span><span class="op">]</span>, Y<span class="op">=</span><span class="va">birthwt</span><span class="op">$</span><span class="va">low</span><span class="op">)</span>

<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dev_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co">#n is the number of observations.</span>
<span class="va">z</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="co">#this is the risk threshold.</span></code></pre></div>
<p>This is how the data looks like:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dev_data</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##    age lwt smoke Y</span>
<span class="co">## 85  19 182     0 0</span>
<span class="co">## 86  33 155     0 0</span>
<span class="co">## 87  20 105     1 0</span>
<span class="co">## 88  21 108     1 0</span>
<span class="co">## 89  18 107     1 0</span>
<span class="co">## 91  21 124     0 0</span></code></pre>
</div>
<div class="section level3">
<h3 id="the-proposed-model">The ‘proposed’ model<a class="anchor" aria-label="anchor" href="#the-proposed-model"></a>
</h3>
<p>To proceed, we fit an uncomplicated logistic regression model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">lwt</span> <span class="op">+</span> <span class="va">smoke</span>, data<span class="op">=</span><span class="va">dev_data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link<span class="op">=</span><span class="st">"logit"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>And this is a summary of this proposed model:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">## Call:  glm(formula = Y ~ age + lwt + smoke, family = binomial(link = "logit"), </span>
<span class="co">##     data = dev_data)</span>
<span class="co">## </span>
<span class="co">## Coefficients:</span>
<span class="co">## (Intercept)          age          lwt        smoke  </span>
<span class="co">##     1.36823     -0.03899     -0.01214      0.67076  </span>
<span class="co">## </span>
<span class="co">## Degrees of Freedom: 188 Total (i.e. Null);  185 Residual</span>
<span class="co">## Null Deviance:       234.7 </span>
<span class="co">## Residual Deviance: 222.9     AIC: 230.9</span></code></pre>
<p>Let’s go ahead and calculate the predicted risks (π , and in R code we write them is ‘pi’) for each patients:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>,type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dev_data</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##    age lwt smoke Y        pi</span>
<span class="co">## 85  19 182     0 0 0.1705285</span>
<span class="co">## 86  33 155     0 0 0.1418425</span>
<span class="co">## 87  20 105     1 0 0.4961377</span>
<span class="co">## 88  21 108     1 0 0.4773007</span>
<span class="co">## 89  18 107     1 0 0.5095645</span>
<span class="co">## 91  21 124     0 0 0.2777118</span></code></pre>
</div>
<div class="section level3">
<h3 id="the-net-benefit-of-the-proposed-model">The net benefit of the proposed model<a class="anchor" aria-label="anchor" href="#the-net-benefit-of-the-proposed-model"></a>
</h3>
<p>Our metric of interest is Net Benefit (NB). At risk threshold of z, it is calculated as</p>
<p><span class="math inline">\(P(\text{True positive}) - P(\text{False positive})\frac{z}{1-z}\)</span></p>
<p>Which in the sample can be estimated as</p>
<p><span class="math inline">\(NB(z)=\sum_{i=1}^nI(π_i&gt;z)\{Y_i-(1-Y_i)\frac{z}{1-z}\}\)</span></p>
<p>Which translates to the following code:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>

<span class="va">NB_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span><span class="op">&gt;</span><span class="va">z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">Y</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">dev_data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">NB_model</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.1574074</span></code></pre>
</div>
<div class="section level3">
<h3 id="uncertainty-in-predicted-risks-from-the-proposed-model">Uncertainty in predicted risks from the proposed model<a class="anchor" aria-label="anchor" href="#uncertainty-in-predicted-risks-from-the-proposed-model"></a>
</h3>
<p>Because the sample size is finite (and in fact quite small in this example), regression coefficients are uncertain. Our model is therefore likely different from the ‘correct model’; that is, the model with correct coefficients.</p>
<p>Because of this discrepancy, the use of the proposed model will be sub-optimal compared with the use of the correct model. As such, making decisions about patient management based on predicted risks from the proposed model can be different from the decision based on the correct risks.</p>
<p>The EVPI captures the expected loss in NB because of not knowing the correct risks.</p>
</div>
<div class="section level3">
<h3 id="nb-calculations-if-the-correct-model-is-known">NB calculations if the correct model is known<a class="anchor" aria-label="anchor" href="#nb-calculations-if-the-correct-model-is-known"></a>
</h3>
<p>Imagine for the moment, we know the truth: that the correct model associating our predictors of interest to the risk of the outcome if of the form</p>
<p><span class="math inline">\(logit(P(Y))= 1 - 0.03899*age - 0.01*lwt + 0.5*smoke\)</span></p>
<p>Because we know the truth, we can calculate the actual risk of outcome, denoted by p, for each observation in the data set:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fl">0.03899</span><span class="op">*</span><span class="va">dev_data</span><span class="op">$</span><span class="va">age</span><span class="op">-</span><span class="fl">0.01</span><span class="op">*</span><span class="va">dev_data</span><span class="op">$</span><span class="va">lwt</span><span class="op">+</span><span class="fl">0.5</span><span class="op">*</span><span class="va">dev_data</span><span class="op">$</span><span class="va">smoke</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now our data look like</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dev_data</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##    age lwt smoke Y        pi         p</span>
<span class="co">## 85  19 182     0 0 0.1705285 0.1735304</span>
<span class="co">## 86  33 155     0 0 0.1418425 0.1374456</span>
<span class="co">## 87  20 105     1 0 0.4961377 0.4182893</span>
<span class="co">## 88  21 108     1 0 0.4773007 0.4016031</span>
<span class="co">## 89  18 107     1 0 0.5095645 0.4324603</span>
<span class="co">## 91  21 124     0 0 0.2777118 0.2575408</span></code></pre>
<p>Now that we have the correct risks, we can calculate the net benefit directly using p:</p>
<p><span class="math inline">\(NB(z)=\sum_{i=1}^n I(π_i&gt;z)(p_i-(1-p_i)\frac{z}{1-z})\)</span></p>
<p>This is very similar to the original euqation for NB, only that we have replaced Y with correct probabilities. Implementing this in R, we have</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NB_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span><span class="op">&gt;</span><span class="va">z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">NB_model</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.1073516</span></code></pre>
<p>We similarly calculate the NB of treating all:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NB_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">NB_all</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.09654724</span></code></pre>
</div>
<div class="section level3">
<h3 id="the-highest-nb-the-nb-of-the-correct-model-itself-nb_max">The highest NB: the NB of the correct model itself (<span class="math inline">\(NB_{max}\)</span>)<a class="anchor" aria-label="anchor" href="#the-highest-nb-the-nb-of-the-correct-model-itself-nb_max"></a>
</h3>
<p>If we know the correct model, then why even using our proposed model? We can calculate the NB of the correct model</p>
<p><span class="math inline">\(NB_{max}(z)= \sum_{i=1}^n I(p_i&gt;z)(p_i-(1-p_i)\frac{z}{1-z})\)</span></p>
<p>Which is easy to calculate:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NB_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span><span class="op">&gt;</span><span class="va">z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">dev_data</span><span class="op">$</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">NB_max</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.1076502</span></code></pre>
</div>
<div class="section level3">
<h3 id="but-we-dont-know-the-correct-model-but-a-bayesian-perspective-helps">But we don’t know the correct model (but a Bayesian perspective helps)<a class="anchor" aria-label="anchor" href="#but-we-dont-know-the-correct-model-but-a-bayesian-perspective-helps"></a>
</h3>
<p>The above calculations was based on the complete knowledge about the correct model. However, we do now know the correct model! How should we proceed?</p>
<p>Because we have the development sample, we can infer about the parameters of the correct model. This requires a Bayesian approach towards NB calculations. The uncertainty in the regression coefficients can be seen as a probability distribution around the parameters of the correct model.</p>
<p>Sampling from the distribution of the regression coefficients for the correct model can be done in many different ways. It can be fully Bayesian, likelihood-based, or based on bootstrapping (as discussed in the paper).</p>
<p>Bootstrap seems a good choice because of its flexibility. We bootstrap the development data set, and fit a new model every time. We make predictions from this model to the original data set. These predicted risks can be taken as samples from the predicted risks of the correct model.</p>
<p>The algorithm looks like this: 1. Obtain a bootstrap sample from the development data set. 2. Fit the model again in this sample. 3. Use this model to make predictions in the original sample. 4. Calculate the NBs of the proposed model, NB of treating all, and NB of using the correct model (as explained above). Store the results in memory 5. Repeat steps 1-4 many times.</p>
<p>This is how it looks in R:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Vectors that will keep the results </span>
<span class="va">NB_model</span> <span class="op">&lt;-</span> <span class="va">NB_max</span> <span class="op">&lt;-</span> <span class="va">NB_all</span> <span class="op">&lt;-</span> <span class="fl">0</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>
<span class="op">{</span>
  <span class="co">#Bootsrapping the development sample</span>
  <span class="va">bs_data</span> <span class="op">&lt;-</span> <span class="va">dev_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, size <span class="op">=</span> <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="op">]</span>
  <span class="co">#Fitting the model in this sample. </span>
  <span class="va">bs_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">lwt</span> <span class="op">+</span> <span class="va">smoke</span>, data<span class="op">=</span><span class="va">bs_data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link<span class="op">=</span><span class="st">"logit"</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#predictions from this model in the development sample can be taken as the correct model for the moment</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bs_model</span>, newdata <span class="op">=</span> <span class="va">dev_data</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span>
  <span class="co">#Calculations of NBs taking p as the correct risk</span>
  <span class="va">NB_model</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span><span class="op">&gt;</span><span class="va">z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">NB_all</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">NB_max</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">p</span><span class="op">&gt;</span><span class="va">z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">p</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Let’s look at how these quantities are distributed:</p>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Clearly, NB_model and NB_max have generally higher values. NB_max slightly edges out NB_model (which will become obvious when we calculate the means):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ENB_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">NB_model</span><span class="op">)</span>
<span class="va">ENB_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">NB_all</span><span class="op">)</span>
<span class="va">ENB_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">NB_max</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-value-of-knowing-the-truth-evpi">The value of knowing the truth: EVPI<a class="anchor" aria-label="anchor" href="#the-value-of-knowing-the-truth-evpi"></a>
</h3>
<p>Having the three quantities at hand, we can know estimate how much knowing the correct model will get us extra NB.</p>
<p>With current information, the best NB we can get is to pick the decision with the highest expected NB</p>
<p><code>$NB_\text{current information}=max\{\text{E}NB_{model}, \text{E}NB_{all}, 0\}$</code></p>
<p>Note that 0 is the NB of not treating anyone.</p>
<p>If we had access to the correct model, we would have used it instead of the proposed model. So the expected gain would be <span class="math inline">\(NB_\text{perfect information}=max\{\text{E}NB_{max}, \text{E}NB_{all}, 0\} = \text{E}NB_{max}\)</span></p>
<p>*Note that <span class="math inline">\(\text{E}NB_{max}\)</span> is guaranteed to be more than the other quantities so the maximization is redundant.</p>
<p>The difference between the expected NB under perfect and current information is the Expected Value of Perfect Information:</p>
<p><span class="math inline">\(EVPI=\text{E}NB_{max}-max\{\text{E}NB_{model}, \text{E}NB_{all}, 0\}\)</span></p>
<p>In R, it is just too easy to calculate EVPI based on the quantities we have calculated so far:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">EVPI</span> <span class="op">&lt;-</span> <span class="va">ENB_max</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">ENB_model</span>,<span class="va">ENB_all</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">EVPI</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.005000959</span></code></pre>
<p>So, with knowing the truth we expect to gain 0.005001 higher expected NB compared with the proposed model at the chosen threshold of 0.2.</p>
</div>
<div class="section level3">
<h3 id="putting-things-together-r-code-for-evpi-calculation">Putting things together: R code for EVPI calculation<a class="anchor" aria-label="anchor" href="#putting-things-together-r-code-for-evpi-calculation"></a>
</h3>
<p>The code below consolidates everything, and also does the calculations for a range of threshold:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dev_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">z</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">99</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span>
<span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span> <span class="co">#Predicted risks</span>

<span class="co">#Step 2:</span>
<span class="va">NB_model</span> <span class="op">&lt;-</span> <span class="va">NB_all</span> <span class="op">&lt;-</span> <span class="va">NB_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sim</span><span class="op">)</span> 
<span class="op">{</span>
  <span class="co">#Step 2.1</span>
  <span class="va">bs_data</span> <span class="op">&lt;-</span>  <span class="va">dev_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="op">]</span> 
  <span class="va">bs_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">lwt</span> <span class="op">+</span> <span class="va">smoke</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link<span class="op">=</span><span class="st">"logit"</span><span class="op">)</span>, data<span class="op">=</span><span class="va">bs_data</span><span class="op">)</span>
  <span class="co">#Step 2.2</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bs_model</span>, newdata <span class="op">=</span>  <span class="va">dev_data</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span> <span class="co">#draw from correct risks   </span>
  <span class="co">#Step 2.3 </span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">NB_all</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">NB_all</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">p</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">n_sim</span> <span class="co">#NB of treating all</span>
    <span class="va">NB_model</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">NB_model</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">dev_data</span><span class="op">$</span><span class="va">pi</span><span class="op">&gt;</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">p</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">n_sim</span> <span class="co">#NB of using the model</span>
    <span class="va">NB_max</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">NB_max</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">p</span><span class="op">&gt;</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">p</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">z</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">n_sim</span> <span class="co">#NB of using the correct risks</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">#Step 4</span>
<span class="va">EVPI</span> <span class="op">&lt;-</span> <span class="va">NB_max</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">NB_model</span>,<span class="va">NB_all</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">EVPI</span>, xlab<span class="op">=</span><span class="st">"Threshold"</span>, ylab<span class="op">=</span><span class="st">"EVPI"</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="how-to-interpret-evpi">How to interpret EVPI?<a class="anchor" aria-label="anchor" href="#how-to-interpret-evpi"></a>
</h3>
<p>EVPI is in the true positive scale. This is rather context-specific. We think EVPI can best be interpreted compared to the NB that the proposed model provides. To this end, we propose Incremental NB and Relative EVPI.</p>
<p>To proceed, we note that we have three Nb entities to compare: - NB of the best decision without any risk stratification: <span class="math inline">\(max(0,\text{E}NB_{all})\)</span> - NB of the best decision with the proposed model: <span class="math inline">\(max(0,\text{E}NB_{all},\text{E}NB_{model})\)</span> - NB of the best decision with the correct model: <span class="math inline">\(NB_{max}\)</span></p>
<p>So, the Incremental Benefit (ΔNB) with current information is</p>
<p><span class="math inline">\(\text{E}INB_\text{Current Information}=max(0,\text{E}NB_{all},\text{E}NB_{model}) - max(0,\text{E}NB_{all})\)</span></p>
<p>Where is with perfect information it is:</p>
<p><span class="math inline">\(\text{E}INB_\text{Perfect Information}=NB_{max}-max(0,\text{E}NB_{all})\)</span></p>
<p>Which can be calculated as</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">INB_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">NB_model</span>,<span class="va">NB_all</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">NB_all</span><span class="op">)</span>
<span class="va">INB_perfect</span> <span class="op">&lt;-</span> <span class="va">NB_max</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">NB_all</span><span class="op">)</span></code></pre></div>
<p>Our suggestion for the graphical presentation is an overlay of the two INB plots:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">INB_current</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="st">'black'</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">INB_current</span>,<span class="va">INB_perfect</span><span class="op">)</span><span class="op">)</span>, xlab<span class="op">=</span><span class="st">"Threshold"</span>, ylab<span class="op">=</span><span class="st">"Incremental NB"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">z</span>,<span class="va">NB_max</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">NB_all</span><span class="op">)</span>,type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="st">'red'</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">INB_current</span>,<span class="va">INB_perfect</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Which nicely shows the difference between the INB curves across the thresholds. This difference is the EVPI, and this graphs shows its extent compared with the gain in NB with the proposed model.</p>
<p>As well, we suggest taking the ratio of the two, which we call Relative EVPI (EVPIr):</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">EVPIr</span> <span class="op">&lt;-</span> <span class="va">INB_perfect</span><span class="op">/</span><span class="va">INB_current</span></code></pre></div>
<p>However, a simple plot of this graph might not be very informative (especially with small samples like ours):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">EVPIr</span>, type<span class="op">=</span><span class="st">'l'</span>, xlab<span class="op">=</span><span class="st">"Threshold"</span>, ylab<span class="op">=</span><span class="st">"Relative EVPI"</span><span class="op">)</span></code></pre></div>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>This is indeed a messy, uninformative graph, and the reason is obvious in the INB graph: in many instances, the INB under current information, the denominator, is 0. If INB under perfect information is 0 (like around threshold value of XXX) we will get 0/0 NaN. If INB under perfect information is non-zero, with get +∞. These have two different meanings:</p>
<ul>
<li><p>An EVPIr of 0/0 means under perfect (and thus correct) information, the model is not expected to do better than the default decisions.</p></li>
<li><p>An EVPIr of +∞ means that while under current information the model is not expected to do better than default decisions, under perfect information it might! Thus the model is not good to go towards validation. But procuring more development sample and revising the model might be justified.</p></li>
</ul>
<p>The EVPIr graph can therefore be upgraded to accomodate these. We cap it on the Y-axis at 10 (to us, an EVPIr of &gt;10 has the same implications as an EVPIr=+∞). We also label the areas of the X-axis according to whether EVPIr is 0/0 or +∞.</p>
<p>So we do a little processing to identify the areas where EVPIr is 0/0 versus +∞:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">max_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">EVPIr</span>,na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="fl">10</span><span class="op">)</span>
<span class="va">yNaN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>
<span class="va">yNaN</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.nan</a></span><span class="op">(</span><span class="va">EVPIr</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">yInf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>
<span class="va">yInf</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">EVPIr</span><span class="op">&gt;</span><span class="fl">10</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">z</span>, <span class="va">EVPIr</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="st">'red'</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">max_y</span><span class="op">)</span>, xlab<span class="op">=</span><span class="st">"Threshold"</span>, ylab<span class="op">=</span><span class="st">"Relative EVPI"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>new<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">yNaN</span>, <span class="va">w</span>, border<span class="op">=</span><span class="st">'grey'</span>, col<span class="op">=</span><span class="st">'grey'</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">max_y</span><span class="op">)</span>, xlab<span class="op">=</span><span class="cn">NULL</span>, ylab<span class="op">=</span><span class="cn">NULL</span>, space<span class="op">=</span><span class="fl">0</span>, axes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>new<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">yInf</span>, <span class="va">w</span>, border<span class="op">=</span><span class="st">'black'</span>, col<span class="op">=</span><span class="st">'black'</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">max_y</span><span class="op">)</span>, xlab<span class="op">=</span><span class="cn">NULL</span>, ylab<span class="op">=</span><span class="cn">NULL</span>, space<span class="op">=</span><span class="fl">0</span>, axes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="fl">0.8</span>,<span class="fl">9</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0/0"</span>,<span class="st">"&gt;10"</span><span class="op">)</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"black"</span><span class="op">)</span>, lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, border<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></code></pre></div>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="using-the-voipred-package">Using the voipred package<a class="anchor" aria-label="anchor" href="#using-the-voipred-package"></a>
</h3>
<p>The voipred packages encapsulates much of what we have done. Its latest experimental version can be installed via github as</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"resplab/voipred"</span><span class="op">)</span></code></pre></div>
<p>Once installed…</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">voipred</span><span class="op">)</span></code></pre></div>
<p>At bare minimum, the voi_glmnet() function in this package requires the model as a GLM object, and the number of simulations requested</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/voi_glm.html">voi_glm</a></span><span class="op">(</span>n_sim<span class="op">=</span><span class="fl">1000</span>,glm_object<span class="op">=</span><span class="va">model</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">EVPI</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">threshold</span><span class="op">==</span><span class="fl">0.2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.004828307</span></code></pre>
<p>The voi_glm function also incorporates likelihood-based and Bayesian bootstrap calculations. We can use this opportunity yo compare the results.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res_ML</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/voi_glm.html">voi_glm</a></span><span class="op">(</span>n_sim<span class="op">=</span><span class="fl">1000</span>,glm_object<span class="op">=</span><span class="va">model</span>, mc_type <span class="op">=</span> <span class="st">"likelihood"</span><span class="op">)</span>
<span class="va">res_BB</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/voi_glm.html">voi_glm</a></span><span class="op">(</span>n_sim<span class="op">=</span><span class="fl">1000</span>,glm_object<span class="op">=</span><span class="va">model</span>, mc_type <span class="op">=</span> <span class="st">"Bayesian_bootstrap"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">threshold</span>, <span class="va">res</span><span class="op">$</span><span class="va">EVPI</span>, xlab<span class="op">=</span><span class="st">"Threshold"</span>, ylab<span class="op">=</span><span class="st">"EVPI"</span>, type<span class="op">=</span><span class="st">'l'</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">threshold</span>, <span class="va">res_ML</span><span class="op">$</span><span class="va">EVPI</span>, col<span class="op">=</span><span class="st">'blue'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">threshold</span>, <span class="va">res_BB</span><span class="op">$</span><span class="va">EVPI</span>, col<span class="op">=</span><span class="st">'green'</span><span class="op">)</span></code></pre></div>
<p><img src="devEVPI_tutorial_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mohsen Sadatsafavi.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
